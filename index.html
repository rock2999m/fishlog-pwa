<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>釣果記録・登録フロー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2em auto; background:#fafbfe;}
    h2, h3 { margin-top: 0; }
    .hidden { display:none; }
    .row { margin-bottom: 0.8em; }
    label { display:inline-block; width:90px; }
    input, select, textarea { font-size:1em; width:60%; }
    input[type="file"] { width:100%; }
    button { padding:0.7em 2em; margin-top:1em; font-size:1em; border-radius:6px; border:none; background:#3887ef; color:#fff; }
    button:disabled { background: #c5defa; color:#333;}
    #previewImg { max-width: 220px; border-radius:8px; }
    #overlay {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(30,30,40,0.45); z-index:1000; justify-content:center; align-items:center; flex-direction:column;
    }
    .spinner {
      width: 48px; height: 48px; border: 5px solid #c5defa; border-top: 5px solid #3887ef; border-radius: 50%; animation: spin 1s linear infinite; margin:16px;
    }
    @keyframes spin { 100% { transform: rotate(360deg);} }
    .step { background: #fff; border-radius:10px; padding:2em 1.5em; box-shadow:0 2px 12px #0001;}
    .field-label {font-size:0.93em;}
  </style>
</head>
<body>

<!-- Step1: 入力画面 -->
<div class="step" id="step1">
  <h2>釣果記録 入力</h2>
  <div class="row"><label>画像</label><input type="file" id="photo" accept="image/*" required></div>
  <div class="row"><label>魚種</label><input type="text" id="species" required></div>
  <div class="row"><label>サイズ</label><input type="number" id="size" required></div>
  <div class="row"><label>場所</label><input type="text" id="place" required></div>
  <div class="row"><label>日付</label><input type="date" id="date" required></div>
  <div class="row"><label>メモ</label><input type="text" id="memo"></div>
  <button type="button" id="nextBtn">次へ</button>
</div>

<!-- Step2: 確認・編集画面 -->
<div class="step hidden" id="step2">
  <h2>内容のご確認・編集</h2>
  <img id="previewImg" src=""><br>
  <div class="row"><span class="field-label">日付</span><input type="date" id="conf_date"></div>
  <div class="row"><span class="field-label">時間</span><input type="text" id="conf_time"></div>
  <div class="row"><span class="field-label">魚種</span><input type="text" id="conf_fish"></div>
  <div class="row"><span class="field-label">サイズ</span><input type="number" id="conf_size"></div>
  <div class="row"><span class="field-label">場所</span><input type="text" id="conf_place"></div>
  <div class="row"><span class="field-label">港</span><input type="text" id="conf_harbor"></div>
  <div class="row"><span class="field-label">潮</span><input type="text" id="conf_tideTitle"></div>
  <div class="row"><span class="field-label">潮位</span><input type="number" id="conf_tideHeight"></div>
  <div class="row"><span class="field-label">潮傾向</span><input type="text" id="conf_trendText"></div>
  <div class="row"><span class="field-label">満潮</span><input type="text" id="conf_highTide"></div>
  <div class="row"><span class="field-label">干潮</span><input type="text" id="conf_lowTide"></div>
  <div class="row"><span class="field-label">メモ</span><input type="text" id="conf_memo"></div>
  <button id="registerBtn">登録</button>
</div>

<!-- オーバーレイ・確認中 -->
<div id="overlay">
  <div style="color:#fff;font-size:1.1em;">確認中...</div>
  <div class="spinner"></div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxT9ZuIfeXmiYeKSpS3XK_drd_tQ0fC0XMLAa7jX-fQmQoO4JKvpazPGYadUPck_elrzQ/exec';

const $ = id => document.getElementById(id);

// 1. 「次へ」クリック
$('nextBtn').onclick = async () => {
  const photo = $('photo').files[0];
  if (!photo) return alert('画像を選択してください');
  // 必須チェック
  for (let id of ['species','size','place','date']) {
    if (!$(''+id).value) return alert('必須項目を入力してください');
  }
  // グレーアウト＋アニメ
  $('overlay').style.display = 'flex';

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result.split(',')[1];
    const fd = new FormData();
    fd.append('photo_base64', base64);
    fd.append('photo_name', photo.name);
    fd.append('species', $('species').value);
    fd.append('size', $('size').value);
    fd.append('place', $('place').value);
    fd.append('date', $('date').value);
    fd.append('memo', $('memo').value);

    try {
      const res = await fetch(GAS_URL, { method:'POST', body: fd });
      const json = await res.json();
      $('overlay').style.display = 'none';
      if (json.error) {
        alert("解析に失敗しました: " + json.error);
        return;
      }
      // ステップ切替
      $('step1').classList.add('hidden');
      $('step2').classList.remove('hidden');

      $('previewImg').src = json.photoUrl || '';
      // 値セット（空欄許容で "" fallback）
      $('conf_date').value = (json.date||"").replace(/\//g, "-");
      $('conf_time').value = json.time || "";
      $('conf_fish').value = json.fish || "";
      $('conf_size').value = json.size || "";
      $('conf_place').value = json.place || "";
      $('conf_harbor').value = json.harbor || "";
      $('conf_tideTitle').value = json.tideTitle || "";
      $('conf_tideHeight').value = json.tideHeight || "";
      $('conf_trendText').value = json.trendText || "";
      $('conf_highTide').value = json.highTide || "";
      $('conf_lowTide').value = json.lowTide || "";
      $('conf_memo').value = json.memo || "";
      // バックアップ
      window.fishlogPreview = json;
    } catch(e) {
      $('overlay').style.display = 'none';
      alert('サーバエラー: ' + e);
    }
  }
  reader.readAsDataURL(photo);
};

// 2. 「登録」クリック
$('registerBtn').onclick = async () => {
  // 編集内容で再送
  const orig = window.fishlogPreview;
  if (!orig) return;
  const fd = new FormData();
  fd.append('date', $('conf_date').value.replace(/-/g,"/"));
  fd.append('time', $('conf_time').value);
  fd.append('fish', $('conf_fish').value);
  fd.append('size', $('conf_size').value);
  fd.append('place', $('conf_place').value);
  fd.append('harbor', $('conf_harbor').value);
  fd.append('tideTitle', $('conf_tideTitle').value);
  fd.append('tideHeight', $('conf_tideHeight').value);
  fd.append('trendText', $('conf_trendText').value);
  fd.append('highTide', $('conf_highTide').value);
  fd.append('lowTide', $('conf_lowTide').value);
  fd.append('memo', $('conf_memo').value);
  // 緯度経度など追加項目はそのまま
  ['lat','lon','photoUrl'].forEach(k=>orig[k] && fd.append(k, orig[k]));

  // 画面グレーアウト＋アニメ
  $('overlay').style.display = 'flex';
  try {
    const res = await fetch(GAS_URL, { method:'POST', body: fd });
    const json = await res.json();
    $('overlay').style.display = 'none';
    alert('登録しました！');
    window.location.reload();
  } catch(e) {
    $('overlay').style.display = 'none';
    alert('登録時エラー: ' + e);
  }
};
</script>
</body>
</html>
