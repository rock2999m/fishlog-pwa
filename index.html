<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>釣果記録・登録フロー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2em auto; background:#fafbfe;}
    h2, h3 { margin-top: 0; }
    .hidden { display:none; }
    .row { margin-bottom: 0.8em; }
    label { display:inline-block; width:90px; }
    input, select, textarea { font-size:1em; width:60%; }
    input[type="file"] { width:100%; }
    button { padding:0.7em 2em; margin-top:1em; font-size:1em; border-radius:6px; border:none; background:#3887ef; color:#fff; }
    button:disabled { background: #c5defa; color:#333;}
    #previewImg { max-width: 220px; border-radius:8px; }
    .step { background: #fff; border-radius:10px; padding:2em 1.5em; box-shadow:0 2px 12px #0001;}
    .field-label {font-size:0.93em;}
    #overlay {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(30,30,40,0.20); z-index:1000; justify-content:center; align-items:center; flex-direction:column;
    }
    #overlayInner {
      background:rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 2px 16px #0002;
      border: 2.5px solid #8bb2e6;
      min-width:220px;
      padding: 36px 36px 24px 36px;
      display:flex; flex-direction:column; align-items:center;
    }
    .spinner {
      width: 52px; height: 52px; border: 7px solid #e1e8f6; border-top: 7px solid #3887ef; border-radius: 50%; animation: spin 1s linear infinite; margin:18px;
    }
    @keyframes spin { 100% { transform: rotate(360deg);} }
    #map { width:100%; height:180px; border-radius:12px; margin:0.7em 0; border:1.5px solid #d7e4fa; }
    #tideGraph { width:100%; max-width:380px; height:140px; margin:10px 0 0 0; border:1.5px solid #d7e4fa; border-radius:10px;}
    #mapModal {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(30,40,70,0.16); z-index:2000; align-items:center; justify-content:center;
    }
    #mapModalInner {
      background:#fff; padding:14px 18px; border-radius:10px; box-shadow:0 2px 16px #0004;
    }
    #modalMap { width:350px; height:320px;}
    #mapModalBtns { text-align:right; margin-top:10px;}
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjf_woLlnqkPXrvUe2b8hGQbGj3hlfV2Q"></script>
</head>
<body>

<!-- Step1: 入力画面 -->
<div class="step" id="step1">
  <h2>釣果記録 入力</h2>
  <div class="row"><label>画像</label><input type="file" id="photo" accept="image/*"></div>
  <div class="row"><label>魚種</label><input type="text" id="species"></div>
  <div class="row"><label>サイズ</label><input type="number" id="size"></div>
  <div class="row" style="display:flex; align-items:center;">
    <label style="flex:0 0 90px;">場所</label>
    <input type="text" id="place" style="flex:1 1 auto; min-width:0; margin-right:7px;">
    <button type="button" id="pickMapBtn" style="flex:0 0 auto; min-width:70px; padding: 0 18px; height: 34px; line-height: 34px; font-size: 0.97em; margin:0; background: #468dfb; color: #fff; border: none; border-radius: 7px; display: inline-block; vertical-align: middle; box-sizing: border-box; cursor: pointer;">MAP</button>
  </div>
  <div class="row"><label>日付</label><input type="date" id="date"></div>
  <div class="row"><label>時間</label><input type="time" id="time" step="1"></div>
  <div class="row"><label>メモ</label><input type="text" id="memo"></div>
  <button type="button" id="nextBtn">次へ</button>
</div>

<!-- Step2: 確認・編集画面 -->
<div class="step hidden" id="step2">
  <h2>内容のご確認・編集</h2>
  <img id="previewImg" src=""><br>
  <div class="row"><span class="field-label">日付</span><input type="date" id="conf_date"></div>
  <div class="row"><span class="field-label">時間</span><input type="time" id="conf_time" step="1"></div>
  <div class="row"><span class="field-label">魚種</span><input type="text" id="conf_fish"></div>
  <div class="row"><span class="field-label">サイズ</span><input type="number" id="conf_size"></div>
  <div class="row"><span class="field-label">場所</span><input type="text" id="conf_place"></div>
  <div class="row"><span class="field-label">潮</span><input type="text" id="conf_tideTitle"></div>
  <div class="row"><span class="field-label">潮位</span><input type="number" id="conf_tideHeight"></div>
  <div class="row"><span class="field-label">潮傾向</span><input type="text" id="conf_trendText"></div>
  <div class="row"><span class="field-label">満潮</span><input type="text" id="conf_highTide"></div>
  <div class="row"><span class="field-label">干潮</span><input type="text" id="conf_lowTide"></div>
  <div class="row"><span class="field-label">メモ</span><input type="text" id="conf_memo"></div>
  <div id="map"></div>
  <canvas id="tideGraph"></canvas>
  <button id="registerBtn">登録</button>
</div>

<!-- モーダル地図選択 -->
<div id="mapModal">
  <div id="mapModalInner">
    <div id="modalMap"></div>
    <div id="mapModalBtns">
      <button id="mapSelectBtn">この位置に決定</button>
      <button id="mapCancelBtn">キャンセル</button>
    </div>
  </div>
</div>

<!-- オーバーレイ・確認中 -->
<div id="overlay">
  <div id="overlayInner">
    <div style="color:#2a4b7c;font-size:1.1em; font-weight:bold;">確認中...</div>
    <div class="spinner"></div>
  </div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxBXNkHpfOolHrwYuClS1SOTZu3k0AYeDYf7Ux4eyekrSelyr5mN7wb_5FJYs_OBdVSLQ/exec';

const $ = id => document.getElementById(id);

// ------ 地図から場所選択 モーダル --------
let pickedLatLng = null;
$('pickMapBtn').onclick = function(){
  $('mapModal').style.display = 'flex';
  setTimeout(()=>{
    const map = new google.maps.Map($('modalMap'), {
      center: { lat: 34.7, lng: 135.3 },
      zoom: 11
    });
    let marker = null;
    map.addListener('click', function(e){
      if(marker) marker.setMap(null);
      marker = new google.maps.Marker({ position: e.latLng, map: map });
      pickedLatLng = e.latLng;
    });
  }, 50);
};

$('mapCancelBtn').onclick = function(){
  $('mapModal').style.display = 'none';
  pickedLatLng = null;
};

$('mapSelectBtn').onclick = function(){
  if(!pickedLatLng){
    alert('地図上で位置をクリックしてください');
    return;
  }
  $('place').value = `${pickedLatLng.lat().toFixed(6)},${pickedLatLng.lng().toFixed(6)}`;
  $('mapModal').style.display = 'none';
};

// ------- 入力→確認 -------
$('nextBtn').onclick = async () => {
  const photo = $('photo').files[0];
  $('overlay').style.display = 'flex';

  // 必須: 魚種・サイズ、写真なしなら場所（緯度経度）と日付・時間
  if(!$('species').value.trim() || !$('size').value.trim()){
    $('overlay').style.display = 'none';
    alert('魚種とサイズは必須です');
    return;
  }
  if(!photo && (!$('place').value.match(/^[-\d.]+,[-\d.]+$/) || !$('date').value || !$('time').value)){
    $('overlay').style.display = 'none';
    alert('写真なしの場合は「地図で場所選択」と日付・時間が必須です');
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = photo ? e.target.result.split(',')[1] : "";
    const fd = new FormData();
    fd.append('photo_base64', base64);
    fd.append('photo_name', photo ? photo.name : "");
    fd.append('species', $('species').value);
    fd.append('size', $('size').value);
    fd.append('place', $('place').value);
    fd.append('date', $('date').value);
    fd.append('time', $('time').value);
    fd.append('memo', $('memo').value);
    fd.append('mode', 'preview');

    try {
      const res = await fetch(GAS_URL, { method:'POST', body: fd });
      const json = await res.json();
      $('overlay').style.display = 'none';
      if (json.error) {
        alert("解析に失敗しました: " + json.error);
        return;
      }
      // step1→step2
      $('step1').classList.add('hidden');
      $('step2').classList.remove('hidden');
      // 画像
      $('previewImg').src = json.photoUrl || '';
      // 項目反映
      $('conf_date').value = (json.date||"").replace(/\//g, "-");
      $('conf_time').value = json.time || "";
      $('conf_fish').value = json.fish || "";
      $('conf_size').value = json.size || "";
      $('conf_place').value = json.harbor || json.place || "";
      $('conf_tideTitle').value = json.tideTitle || "";
      $('conf_tideHeight').value = json.tideHeight || "";
      $('conf_trendText').value = json.trendText || "";
      $('conf_highTide').value = json.highTide || "";
      $('conf_lowTide').value = json.lowTide || "";
      $('conf_memo').value = json.memo || "";

      // Google Map表示（港座標）
      if(json.portLat && json.portLon) {
        setTimeout(()=>{
          const map = new google.maps.Map($('map'), {
            center: {lat: parseFloat(json.portLat), lng: parseFloat(json.portLon)},
            zoom: 15,
            disableDefaultUI: true
          });
          new google.maps.Marker({
            position: {lat: parseFloat(json.portLat), lng: parseFloat(json.portLon)},
            map: map,
            title: $('conf_place').value
          });
        }, 100);
      } else {
        $('map').innerHTML = '港位置が取得できません';
      }

      // 潮位グラフ（24時間データ: json.tideList 配列形式[ {time,cm}, ... ])
      drawTideGraph(json.tideList || [], json.time || "");
      window.fishlogPreview = json;
    } catch(e) {
      $('overlay').style.display = 'none';
      alert('サーバエラー: ' + e);
    }
  }
  if(photo) reader.readAsDataURL(photo); else reader.onload();
};

// 「登録」クリック
$('registerBtn').onclick = async () => {
  const orig = window.fishlogPreview;
  if (!orig) return;
  const fd = new FormData();
  fd.append('date', $('conf_date').value.replace(/-/g,"/"));
  fd.append('time', $('conf_time').value);
  fd.append('fish', $('conf_fish').value);
  fd.append('size', $('conf_size').value);
  fd.append('place', $('conf_place').value);
  fd.append('tideTitle', $('conf_tideTitle').value);
  fd.append('tideHeight', $('conf_tideHeight').value);
  fd.append('trendText', $('conf_trendText').value);
  fd.append('highTide', $('conf_highTide').value);
  fd.append('lowTide', $('conf_lowTide').value);
  fd.append('memo', $('conf_memo').value);
  ['lat','lon','photoUrl'].forEach(k=>orig[k] && fd.append(k, orig[k]));
  fd.append('mode','register');

  $('overlay').style.display = 'flex';
  try {
    const res = await fetch(GAS_URL, { method:'POST', body: fd });
    const json = await res.json();
    $('overlay').style.display = 'none';
    alert('登録しました！');
    window.location.reload();
  } catch(e) {
    $('overlay').style.display = 'none';
    alert('登録時エラー: ' + e);
  }
};

// 潮位グラフ描画
function drawTideGraph(tideList, timeStr){
  const cvs = $('tideGraph');
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  if(!tideList || tideList.length==0) {
    ctx.fillStyle="#999";
    ctx.fillText("潮位データなし",40,60);
    return;
  }
  // グラフスケール計算
  let min = Math.min(...tideList.map(t=>t.cm)), max = Math.max(...tideList.map(t=>t.cm));
  const h = cvs.height, w = cvs.width;
  ctx.beginPath();
  ctx.moveTo(0, h - (tideList[0].cm-min)/(max-min+1)*h*0.8-15);
  tideList.forEach((d,i)=>{
    const x = i * w/(tideList.length-1);
    const y = h - ((d.cm-min)/(max-min+1))*h*0.8-15;
    ctx.lineTo(x, y);
  });
  ctx.strokeStyle="#3380ef"; ctx.lineWidth=2.5; ctx.stroke();

  // 4時間ごとの縦線
  for(let hour=4; hour<24; hour+=4){
    let idx = tideList.findIndex(t=>t.time.startsWith(String(hour).padStart(2,'0')+":"));
    if(idx!==-1){
      let x = idx * w/(tideList.length-1);
      ctx.beginPath();
      ctx.moveTo(x, 10);
      ctx.lineTo(x, h-10);
      ctx.strokeStyle = "#99b7ef";
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  }
  // 軸ラベル
  ctx.fillStyle="#357";
  ctx.font="13px sans-serif";
  ctx.fillText("0:00",2,h-8);
  ctx.fillText("12:00",w/2-24,h-8);
  ctx.fillText("24:00",w-48,h-8);
  ctx.fillText(`${max}cm`,4,24);
  ctx.fillText(`${min}cm`,4,h-18);

  // 釣った時間（縦赤線）
  if(timeStr){
    let hour = parseInt(timeStr.split(':')[0],10), minT = parseInt(timeStr.split(':')[1],10)||0;
    let totalMin = hour*60+minT;
    let idx = Math.round(totalMin/(1440)*(tideList.length-1));
    let x = idx * w/(tideList.length-1);
    ctx.beginPath();
    ctx.moveTo(x, 10);
    ctx.lineTo(x, h-10);
    ctx.strokeStyle = "#e63b1c";
    ctx.lineWidth = 2;
    ctx.stroke();
  }
}
</script>
</body>
</html>
